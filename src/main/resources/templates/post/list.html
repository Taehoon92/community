<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" layout:decorate="layout">

<th:block layout:fragment="content">

    <!--/* 검색 영역 */-->
    <div class="input-group post-list-search" id="adv-search">
        <form id="searchForm" onsubmit="return false;">
            <select id="searchType" class="form-control" style="width: 100px;">
                <option value="">Select</option>
                <option value="title">Title</option>
                <option value="content">Content</option>
                <option value="username">Writer</option>
            </select>
            <input type="text" id="keyword" class="form-control" placeholder="키워드를 입력해 주세요." style="width: 300px;" />
        </form>
        <button type="button" class="btn btn-primary btn-search" onclick="findAll(0)">
            <span class="fa-solid fa-magnifying-glass"></span>
        </button>
    </div>

    <!--/* 게시글 영역 */-->
    <div class="table-responsive clearfix">
        <table class="table table-hover">
            <colgroup>
                <col style="width:5%">
                <col style="width:50%">
                <col style="width:15%">
                <col style="width:20%">
                <col style="width:10%">

            </colgroup>
            <thead>
            <tr>
                <th></th>
                <th scope="col">Title</th>
                <th scope="col">Writer</th>
                <th scope="col">Date</th>
                <th scope="col">Hits</th>
            </tr>
            </thead>

            <!--/* 게시글 리스트 Rendering 영역 */-->
            <tbody id="list">

            </tbody>
        </table>
        <div class="list-button-area">
            <div>

            </div>
            <!-- 페이지네이션 Rendering 영역 -->
            <div id="page-navigation">
            </div>
            <div>
                <a th:href="@{/posts/create}" class="btn-write btn btn-primary waves-effect waves-light">Write</a>
            </div>


        </div>

    </div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">

        let page = 0;
        let size = 10;


        window.onload = () => {
            findAll(page);
            addEnterSearchEvent();
        }

        /**
         * 키워드 - 엔터 검색 이벤트 바인딩
         */
        function addEnterSearchEvent() {

            document.getElementById('keyword').addEventListener('keyup', (e) => {
                if(e.keyCode === 13) {
                    findAll(page);
                }
            });
        }

        function goView(id) {
            location.href = `/posts/${id}`;
        }

        function findAll(page) {
            const searchTypeElement = document.getElementById('searchType');
            const searchType = searchTypeElement.options[searchTypeElement.selectedIndex].value;
            const keyword = document.getElementById('keyword').value;
            console.log(searchType);

            let uri = '';

            if(searchType && keyword) {
                uri += `/api/posts?page=${page}&size=${size}&${searchType}=${keyword}`;
            } else {
                uri += `/api/posts?page=${page}&size=${size}`;
            }



            fetch( uri , {
                method: 'GET',
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
            }).then(json => {
                let html = '';
                let navHtml = '';
                console.log(json.result.data);
                if(json.result.data.postList.length == 0) {
                    //게시글 x
                }
                else {
                    console.log(json.result.data.postList);

                    json.result.data.postList.forEach((obj, idx) => {
                        html += `
                            <tr>
                            <td colspan="2" class = "td-post">
                                <div class = "post-number">
                                    <div class="inner-number">${json.result.data.totalElements - (page * size) - idx}</div>
                                </div>
                                <div class = "post-title">
                                    <div class="inner-title">
                                        <a class="list-subject" href="javascript: void(0);" onclick="goView(${obj.id})">${obj.title}</a>
                                        <span class="list-icon"></span>
                                        <span class="list-reply">[${obj.comments}]</span>
                                    </div>
                                </div>
                            </td>
                            <td class="td-name">
                                <div class="post-name">
                                    <div class="inner-name">${obj.username}</div>
                                </div>
                            </td>
                            <td class="td-date">
                                <div class="post-date">
                                    <div class="inner-date">${moment(obj.createdDate).format('YYYY-MM-DD')}</div>
                                </div>
                            </td>
                            <td class="td-hits">
                                <div class="post-hits">
                                    <div class="inner-hits">${obj.hits}</div>
                                </div>
                            </td>
                        `;
                    });

                    navHtml = generatePageNavButton(json,page);

                }

                document.getElementById('list').innerHTML = html;
                document.getElementById('page-navigation').innerHTML = navHtml;
            }).catch(error => {
                alert('오류가 발생했습니다');
            })


        }

        function generatePageNavButton(json, page) {

            let generatedHtml = '';
            let startPage = parseInt((page) / 10) * 10 + 1;

            if(page != 0) {
                generatedHtml += `
                    <a href="javascript:void(0)", onclick="findAll(0);" aria-label="Previous">&laquo;</a>
                    <a href="javascript:void(0)", onclick="findAll(${page-1});" aria-label="Previous">&lsaquo;</a>
                `;
            }

            for (let i = startPage ; i < startPage+10; i++) {
                if(i >json.result.data.totalPages) {
                    break;
                }

                const active = (i === page+1) ? 'class="active"' : '';

                generatedHtml += `
                    <a href="javascript:void(0)" onclick="findAll(${i-1})" ${active}>${i}</a>`;
            }

            if(json.result.data.hasNext) {
                generatedHtml += `
                    <a href="javascript:void(0)" onclick="findAll(${page + 1});" aria-label="Next">&rsaquo;</a>
                    <a href="javascript:void(0)" onclick="findAll(${json.result.data.totalPages - 1});" aria-label="Next">&raquo;</a>
                `;
            }

            return generatedHtml;


        }

    </script>
</th:block>
</html>